#include <LiquidCrystal.h>

// initialize the library with The numbers of the interface pins
LiquidCrystal lcd(PE_4, PE_5, PD_0, PD_1, PD_2, PD_3);

//LED değişkenleri
const int ledPin =  GREEN_LED; 
const int ledPin2 = RED_LED;
const int ledPin3 = BLUE_LED;

//Butonların pin numarası
const int yirmibes = 28;    
const int elli = 19;
const int bir = 38;
const int paraBitis = 37;
const int su = 36;
const int cay = 35;
const int kahve  = 34;
const int cikolata = 33;
const int biskuvi = 32;
const int siparisBitis = 13;
const int resetTusu = 31;

//Kullanıcı Bakiye Değişkenleri
int yirmibesK = 0;
int elliK = 0;
int birTL = 0;
int tempYirmibes = 0;
int tempElli = 0;
int tempBir = 0;

//Sipariş Değişkenleri
int ssu = 0;
int scay = 0;
int skahve = 0;
int scikolata = 0;
int sbiskuvi = 0;
int tempSu = 0;
int tempCay = 0;
int tempKahve = 0;
int tempCikolata = 0;
int tempBiskuvi = 0;


// Butonlar için değişkenler
int yirmibesDurumu = 0;         
int elliDurumu = 0;
int birDurumu=0;
int paraBitisDurumu = 0;
int suDurumu = 0;
int cayDurumu = 0;
int kahveDurumu = 0;
int cikolataDurumu = 0;
int biskuviDurumu = 0; 
int siparisBitisDurumu = 0;
int resetTusuDurumu = 0;
int i = 0;

const char *input[] = {"20,20,10","1,su,30,0.5","2,cay,20,1.0","3,kahve,15,1.5","4,cikolata,50,1.75","5,biskuvi,100,2.0"};
struct urun{
    int urunId;
    char urunAd[30];
    int urunStok;
    float urunFiyat;
}urunler[5];

struct hesap{
    int para[3];
}banka;

void kasabilgilerinial(char gelensatir[30])
{
    int x=0;
    char *line ;
    char const virgul[2] = "," ;
    line = strtok(gelensatir,virgul);
    while(line != NULL)
    {
        // 20 -> int 20
        banka.para[x] = atoi(line);
        line = strtok(NULL,virgul);
        x++;
    }
}

void urunbilgilerinial(char satir[] , int sayi)
{
    int x = 0 ;
    char *line ;
    char const virgul[2] = "," ;
    line = strtok(satir,virgul);
    while(line != NULL)
    {
        // x = 0 iken ürünün id
        if(x == 0)
        {
            urunler[sayi].urunId = sayi+1 ;
        }
            // x = 1 ne alıyorum nereye göndercem
            // x = 1 -> ürünün ismi var
        else if(x == 1 )
        {
            strcpy(urunler[sayi].urunAd,line);
        }

        else if(x==2)
            urunler[sayi].urunStok=atoi(line);
        else if(x==3)
            urunler[sayi].urunFiyat=atof(line);
        // yazacağın yer  = atoi(string) ;


        line = strtok(NULL,virgul);
        x++ ;
    }
}

float bakiyeyukle(int yirmibes, int ellikurus, int birtl)
{
    float toplam=0;
    toplam+=yirmibes*0.25;
    toplam+=ellikurus*0.50;
    toplam+=birtl*1.0;
    //Burada bir bug varmış gibi geldi.Belki mantığını yanlış anladım.Alttaki 3 satıra bakmak gerek.
    //banka.para[0]+=yirmibes;
    //banka.para[1]+=ellikurus;
    //banka.para[2]+=birtl;

    printf("\nKullanicinin Yukledigi Para Miktari: %0.2f TL\n",toplam);
    
    
    return toplam;

}

void kasayigoster(){
   //Printfler energia da çalışmıyor.
   // printf("\nKasadaki Guncel Bakiye Degerleri:\n");
   // printf("25 Kurus Sayisi: %d \n50 Kurus Sayisi: %d \n1 TL Sayisi: %d\n",banka.para[0],banka.para[1],banka.para[2]);
    float toplam = (banka.para[0]*0.25)+(banka.para[1]*0.5)+(banka.para[2]*1);
    lcd.clear();
    lcd.print("Kasa: ");
    lcd.print(toplam);
    lcd.print("TL");
    
}

//LCD ekrana sığamayacağı için bu fonksiyon devredışı bırakılabilir.
void urunlerigoster(){
    printf("\nUrun Bilgileri \nUrun Adi\t Urun Stogu\t Urun Fiyati\n");
    for (int i = 0; i < 5; i++)
    {
        printf("%s, \t\t %d, \t\t%0.2f \n",urunler[i].urunAd,urunler[i].urunStok,urunler[i].urunFiyat);
    }
}


void urunsec(int a, int b,int c,int d,int f,float kullanicibakiye,float guncelbakiye){
    float harcamatutari=0;
    float paraustu=0;
    int ust=0;
    for (int i = 0; i <5 ; ++i) {
        if(i==0)
            harcamatutari+=a*urunler[i].urunFiyat;
        if(i==1)
            harcamatutari+=b*urunler[i].urunFiyat;
        if(i==2)
            harcamatutari+=c*urunler[i].urunFiyat;
        if(i==3)
            harcamatutari+=d*urunler[i].urunFiyat;
        if(i==4)
            harcamatutari+=f*urunler[i].urunFiyat;
    }

    printf("\nSecilen Urunler icin Harcanacak Tutar: %0.2f\n",harcamatutari);

    if(harcamatutari>kullanicibakiye)// Kullanıcının Parasının Yetmemesi Durumu
        //printf("\nAlisveris icin Bakiyeniz Yetersiz. ");
        lcd.print("Bakiye yetersiz.");
    else if (harcamatutari==kullanicibakiye) // Paranın Tam Yetmesi Durumu
       printf("\nAlisveris Gerceklesir... Para ustu yok.\n");
    else if(harcamatutari<kullanicibakiye)//Verilen Paranın Harcamadan Fazla Olması Paraustu Verilecek
    {
        printf("\nKullanici bakiyesi: %0.2f, Harcama Tutari: %0.2f",kullanicibakiye,harcamatutari);
        paraustu=kullanicibakiye-harcamatutari;
        printf("\nVerilecek Para Ustumuz: %0.2f \nPara Ustu Hesaplaniyor...\n",paraustu);

        //sleep(2);
        while(paraustu!=0.0)
        {
            paraustu-=0.25;
            ust++;
        }
        int birtl=ust/4;
        ust%=4;
        int ellikurus=ust/2;
        ust%=2;

        printf("\nVerilecekler Bozuk Paralar \n 1 TL Sayisi: %d, 50 Kurus Sayisi: %d, 25 Kurus Sayisi: %d\n",birtl,ellikurus,ust);
        banka.para[0]-=ust;
        banka.para[1]-=ellikurus;
        banka.para[2]-=birtl;
        //sleep(2);
    }
}

void bilgigonder()
{
    //Bu kod yorum satırına alınacak
    //int yirmibeskurus=5,ellikurus=10,birtl=15; //Kullanıcı Girdisi

    //int a=2,b=2,c=2,d=2,f=2; // Alınacak Ürünler
    char temp[30];
    strcpy(temp,input[0]);//20 20 10 -> temp
    kasabilgilerinial(temp);
    int i ;
    int sayi = 0  ;
    for(int i = 1 ; i < 6 ; i++)
    {
        strcpy(temp,input[i]);
        urunbilgilerinial(temp,sayi);
        sayi++ ;
    }

    kasayigoster();
    //urunlerigoster();
    float guncelbakiye=(banka.para[0]*0.25)+(banka.para[1]*0.5)+(banka.para[2]*1); //Kasadaki Toplam Para
    float kullanicibakiye;
    
    //yirmibeskurus, ellikurus, birt1 değişkenlerine butonlar ile değer atayan fonksiyon burada çağıralacak
    //lcd.print("BEFORE");
    //delay(3000);
    kullanicibakiye=bakiyeyukle(yirmibesK,elliK,birTL); // Kullanici Bakiyesi

    urunsec(su,cay,kahve,cikolata,biskuvi,kullanicibakiye,guncelbakiye);

    kasayigoster();

}

void bakiye(){
  //Butonlarla alınan kullanıcı bakiyesini gerekli değişkenlere atama
  yirmibesK = tempYirmibes;
  elliK = tempElli;
  birTL = tempBir;
  tempYirmibes = 0;
  tempElli = 0;
  tempBir = 0;
  float toplam = (yirmibesK*0.25) + (elliK*0.5) + (birTL*1);
  lcd.clear();
  lcd.print(toplam);
  lcd.print(" TL para attiniz.");
  
  
  /*char temp[30];
  strcpy(temp,input[0]);//20 20 10 -> temp
  kasabilgilerinial(temp);
  kasayigoster();*/
  
}
void siparisYukle(){
   //Butonlarla alınan kullanıcı siparişlerini gerekli değişkenlere atama
   ssu = tempSu;
   scay = tempCay;
   skahve = tempKahve;
   scikolata = tempCikolata;
   sbiskuvi = tempBiskuvi;
   tempSu = 0;
   tempCay = 0;
   tempKahve = 0;
   tempCikolata = 0;
   tempBiskuvi = 0;
   /*
   lcd.print(ssu);
   lcd.print(" ");
   lcd.print(scay);
   lcd.print(" ");
   lcd.print(skahve);
   lcd.print(" ");
   lcd.print(scikolata);
   lcd.print(" ");
   lcd.print(sbiskuvi);
   */
   bilgigonder();
}

void setup() {
  // set up the LCD's number of columns and rows:
  lcd.begin(16, 2);
  
  
  // initialize the LED pin as an output:
  pinMode(ledPin, OUTPUT);      
  pinMode(ledPin2, OUTPUT);
  
  pinMode(yirmibes, INPUT_PULLUP);     
  pinMode(elli, INPUT_PULLUP);     
  pinMode(bir, INPUT_PULLUP);     
  pinMode(paraBitis, INPUT_PULLUP);     
  pinMode(su, INPUT_PULLUP); 
  pinMode(cay, INPUT_PULLUP);     
  pinMode(kahve, INPUT_PULLUP);     
  pinMode(cikolata, INPUT_PULLUP);     
  pinMode(biskuvi, INPUT_PULLUP);
  pinMode(siparisBitis, INPUT_PULLUP);
  pinMode(resetTusu, INPUT_PULLUP);
  
}

void loop(){
  // read the state of the pushbutton value:  
  yirmibesDurumu = digitalRead(yirmibes);
  elliDurumu = digitalRead(elli);
  birDurumu = digitalRead(bir);
  paraBitisDurumu = digitalRead(paraBitis); 
  suDurumu = digitalRead(su);
  cayDurumu = digitalRead(cay);
  kahveDurumu = digitalRead(kahve);
  cikolataDurumu = digitalRead(cikolata);
  biskuviDurumu = digitalRead(biskuvi);
  siparisBitisDurumu = digitalRead(siparisBitis);
  resetTusuDurumu = digitalRead(resetTusu);
  // check if the pushbutton is pressed.
  // if it is, the buttonState is HIGH:
 /*
   if (siparisBitisDurumu == LOW) { 
    delay(300);
    lcd.clear();
     i = i+1;
    lcd.print(i);
  }
 */
 //Müşteri bakiyesi alma
  if(yirmibesDurumu == LOW){
    delay(300);
    tempYirmibes++;
  }
  if(elliDurumu == LOW){
    delay(300);
    tempElli++;
  }
  if(birDurumu == LOW){
    delay(300);
    tempBir++;
  }
  if(paraBitisDurumu == LOW){
    delay(300);
    bakiye();
  }
 
 //Sipariş alma 
  if(suDurumu == LOW){
    delay(300);
    tempSu++;
    lcd.clear();
  lcd.print("Su");
  }
  if(cayDurumu == LOW){
    delay(300);
    tempCay++;
    lcd.clear();
  lcd.print("Cay");
  }
  if(kahveDurumu == LOW){
    delay(300);
    tempKahve++;
    lcd.clear();
  lcd.print("Kahve");
  }
  if(cikolataDurumu == LOW){
    delay(300);
    tempCikolata++;
    lcd.clear();
  lcd.print("Cikolata");
  }
  if(biskuviDurumu == LOW){
    delay(300);
    tempBiskuvi++;
    lcd.clear();
    lcd.print("Buskivi");
  }
  if(siparisBitisDurumu == LOW){
    delay(300);
    siparisYukle();
  }
}
